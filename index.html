<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONSCRIPTIONS MON-20 V2 - Marketplace & Live Tracking</title>
    <link rel="icon" type="image/jpeg" href="https://files.catbox.moe/405c54.jfif">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Web3 Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        :root {
            --gold-light: #f4e4c1;
            --gold: #d4af37;
            --gold-dark: #b8941e;
            --charcoal: #1a1a1a;
            --charcoal-light: #2a2a2a;
            --cream: #faf8f3;
            --accent: #ff6b35;
            --success: #4ade80;
            --shadow: rgba(212, 175, 55, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--charcoal);
            color: var(--cream);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.03;
            background-image: 
                radial-gradient(circle at 20% 50%, var(--gold) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, var(--gold) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: drift 60s infinite linear;
        }

        @keyframes drift {
            0% { background-position: 0 0, 25px 25px; }
            100% { background-position: 50px 50px, 75px 75px; }
        }

        .glow-orb {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.15;
            pointer-events: none;
            z-index: -1;
        }

        .orb-1 {
            background: var(--gold);
            top: -200px;
            right: -200px;
            animation: float 20s infinite ease-in-out;
        }

        .orb-2 {
            background: var(--accent);
            bottom: -200px;
            left: -200px;
            animation: float 25s infinite ease-in-out reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-50px, 50px) scale(1.1); }
        }

        header {
            background: linear-gradient(135deg, var(--charcoal-light) 0%, rgba(26, 26, 26, 0.95) 100%);
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
            padding: 1.5rem 2rem;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            box-shadow: 0 0 20px var(--shadow);
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--gold-light) 0%, var(--gold) 50%, var(--gold-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .version-badge {
            font-size: 0.7rem;
            background: var(--accent);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .wallet-section {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--charcoal);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px var(--shadow);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--gold);
            color: var(--gold);
        }

        .btn-secondary:hover {
            background: var(--gold);
            color: var(--charcoal);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #22c55e 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--gold-light);
            background: rgba(212, 175, 55, 0.1);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        main {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Live Progress Bar */
        .live-progress-section {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(255, 107, 53, 0.05) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            animation: fadeInUp 1s ease;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .progress-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--gold);
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--success);
        }

        .pulse-dot {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .progress-bar-container {
            background: rgba(0, 0, 0, 0.3);
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-dark) 0%, var(--gold) 50%, var(--gold-light) 100%);
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 1rem;
            font-weight: 700;
            color: var(--charcoal);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .progress-stat {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .progress-stat-label {
            font-size: 0.8rem;
            color: rgba(250, 248, 243, 0.6);
            margin-bottom: 0.5rem;
        }

        .progress-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(212, 175, 55, 0.2);
            overflow-x: auto;
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: rgba(250, 248, 243, 0.6);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--gold-light);
        }

        .tab.active {
            color: var(--gold);
            border-bottom-color: var(--gold);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, var(--charcoal-light) 0%, rgba(42, 42, 42, 0.5) 100%);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: var(--gold-light);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: var(--cream);
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .form-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Marketplace specific styles */
        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .listing-card {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(255, 107, 53, 0.02) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .listing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
            border-color: var(--gold);
        }

        .listing-seller {
            font-size: 0.8rem;
            color: rgba(250, 248, 243, 0.6);
            margin-bottom: 0.5rem;
        }

        .listing-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .listing-price {
            font-size: 1.2rem;
            color: var(--cream);
            margin-bottom: 1rem;
        }

        .listing-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: var(--charcoal-light);
            border: 1px solid var(--gold);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: slideIn 0.5s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            border-color: var(--success);
        }

        .notification.error {
            border-color: var(--accent);
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--gold);
        }

        .notification.success .notification-title {
            color: var(--success);
        }

        .notification.error .notification-title {
            color: var(--accent);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            h1 {
                font-size: 1.4rem;
            }

            .wallet-section {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
            }

            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .marketplace-grid {
                grid-template-columns: 1fr;
            }

            .progress-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    <div class="glow-orb orb-1"></div>
    <div class="glow-orb orb-2"></div>

    <header>
        <div class="header-content">
            <div class="logo-section">
                <img src="https://files.catbox.moe/405c54.jfif" alt="MONS Logo" class="logo">
                <div>
                    <h1>MONSCRIPTIONS<span class="version-badge">V2</span></h1>
                    <div style="font-size: 0.8rem; color: rgba(250, 248, 243, 0.6);">
                        MON-20 Inscription Protocol | 
                        <a href="https://monadvision.com/address/0xed939305a2da8f8a7c2effa64c95fb5b37693ef4" 
                           target="_blank" 
                           style="color: var(--gold); text-decoration: none;">
                            View Contract ‚Üó
                        </a>
                    </div>
                </div>
            </div>
            <div class="wallet-section">
                <button id="connectWallet" class="btn btn-primary">Connect Wallet</button>
                <div id="walletInfo" style="display: none;">
                    <span class="wallet-address" id="walletAddress"></span>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- Network Info Banner -->
        <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h3 style="color: var(--gold); margin-bottom: 0.5rem;">‚ö° Monad Mainnet Required</h3>
                    <p style="color: rgba(250, 248, 243, 0.7); margin: 0;">
                        Chain ID: <strong style="color: var(--gold);">143</strong> | 
                        RPC: <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.5rem; border-radius: 4px; color: var(--gold-light);">https://rpc.monad.xyz</code>
                    </p>
                </div>
                <button id="addNetworkBtn" class="btn btn-secondary" onclick="addMonadNetwork()">
                    ‚ûï Add Monad Network
                </button>
            </div>
        </div>

        <!-- Live Progress Section -->
        <div class="live-progress-section">
            <div class="progress-header">
                <h2 class="progress-title">üî• Live Mint Progress</h2>
                <div class="live-indicator">
                    <span class="pulse-dot"></span>
                    <span>LIVE</span>
                </div>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">
                    <span id="progressPercent">0%</span>
                </div>
            </div>

            <div class="progress-stats">
                <div class="progress-stat">
                    <div class="progress-stat-label">Total Minted</div>
                    <div class="progress-stat-value" id="totalMinted">0</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-label">Max Supply</div>
                    <div class="progress-stat-value">21,000,000</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-label">Total Inscriptions</div>
                    <div class="progress-stat-value" id="totalInscriptions">0</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-label">Total Holders</div>
                    <div class="progress-stat-value" id="totalHolders">0</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-label">Your Balance</div>
                    <div class="progress-stat-value" id="userBalance">0</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="mint">ü™ô Mint</button>
            <button class="tab" data-tab="transfer">üí∏ Transfer</button>
            <button class="tab" data-tab="marketplace">üè™ Marketplace</button>
            <button class="tab" data-tab="myListings">üìã My Listings</button>
        </div>

        <!-- Mint Tab -->
        <div id="mintTab" class="tab-content active">
            <div class="card">
                <h3 class="card-title">Mint MONS Tokens</h3>
                <form id="mintForm">
                    <div class="form-group">
                        <label class="form-label">Number of Mints (Max 100 per wallet)</label>
                        <input type="number" id="mintAmount" class="form-input" min="1" max="100" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">You Will Receive</label>
                        <input type="text" id="receiveAmount" class="form-input" disabled value="100 MONS">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Fee</label>
                        <input type="text" id="totalFee" class="form-input" disabled value="1 MON">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Mint Count</label>
                        <input type="text" id="userMintCount" class="form-input" disabled value="0 / 100">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Mint MONS</button>
                </form>
            </div>
        </div>

        <!-- Transfer Tab -->
        <div id="transferTab" class="tab-content">
            <div class="card">
                <h3 class="card-title">Transfer MONS Tokens</h3>
                <form id="transferForm">
                    <div class="form-group">
                        <label class="form-label">Recipient Address</label>
                        <input type="text" id="recipientAddress" class="form-input" placeholder="0x..." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="transferAmount" class="form-input" min="1" placeholder="100" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transfer Fee</label>
                        <input type="text" class="form-input" disabled value="1 MON">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Transfer Tokens</button>
                </form>
            </div>
        </div>

        <!-- Marketplace Tab -->
        <div id="marketplaceTab" class="tab-content">
            <div class="card">
                <h3 class="card-title">üè™ Marketplace</h3>
                <p style="color: rgba(250, 248, 243, 0.7); margin-bottom: 1.5rem;">
                    Buy and sell MONS tokens with 2.5% marketplace fee
                </p>
                
                <div style="margin-bottom: 2rem;">
                    <button id="refreshListings" class="btn btn-secondary">üîÑ Refresh Listings</button>
                </div>

                <div id="marketplaceListings" class="marketplace-grid">
                    <!-- Listings will be loaded here -->
                </div>
            </div>
        </div>

        <!-- My Listings Tab -->
        <div id="myListingsTab" class="tab-content">
            <div class="card">
                <h3 class="card-title">Create New Listing</h3>
                <form id="createListingForm">
                    <div class="form-group">
                        <label class="form-label">Amount to Sell</label>
                        <input type="number" id="listingAmount" class="form-input" min="1" placeholder="100" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Price Per Token (in MON)</label>
                        <input type="number" id="listingPrice" class="form-input" min="0.000001" step="0.000001" placeholder="0.001" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Price</label>
                        <input type="text" id="totalListingPrice" class="form-input" disabled value="0 MON">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Create Listing</button>
                </form>
            </div>

            <div class="card">
                <h3 class="card-title">Your Active Listings</h3>
                <div id="userListings">
                    <!-- User's listings will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const CONFIG = {
            CONTRACT_ADDRESS: '0xed939305a2da8f8a7c2effa64c95fb5b37693ef4',
            CHAIN_ID: 143, // Monad Mainnet
            CHAIN_NAME: 'Monad Mainnet',
            RPC_URL: 'https://rpc.monad.xyz',
            BLOCK_EXPLORER: 'https://monadvision.com',
            INSCRIPTION_FEE: '1',
            MARKETPLACE_FEE: 2.5,
        };

        // Contract ABI
        const CONTRACT_ABI = [
            "function inscribe(bytes calldata data) external payable",
            "function batchInscribe(bytes[] calldata dataArray) external payable",
            "function transfer(address to, uint256 amount) external payable",
            "function createListing(uint256 amount, uint256 pricePerToken) external returns (uint256)",
            "function cancelListing(uint256 listingId) external",
            "function buyListing(uint256 listingId) external payable",
            "function getMintProgress() external view returns (uint256 minted, uint256 maxSupply, uint256 percentComplete, uint256 inscriptionsCount)",
            "function getUserStats(address user) external view returns (uint256 balance, uint256 mints, uint256 maxMints, uint256 remainingMints)",
            "function getActiveListings(uint256 offset, uint256 limit) external view returns (uint256[] memory listingIds, address[] memory sellers, uint256[] memory amounts, uint256[] memory prices)",
            "function getUserListings(address user) external view returns (uint256[] memory)",
            "function getListing(uint256 listingId) external view returns (address seller, uint256 amount, uint256 pricePerToken, uint256 timestamp, bool active)",
            "function totalMinted() external view returns (uint256)",
            "function totalInscriptions() external view returns (uint256)",
            "function balances(address) external view returns (uint256)",
            "function mintCounts(address) external view returns (uint256)",
            "event TokensMinted(address indexed minter, uint256 amount, uint256 totalMinted, uint256 timestamp)",
            "event ListingCreated(uint256 indexed listingId, address indexed seller, uint256 amount, uint256 pricePerToken, uint256 timestamp)",
            "event ListingFilled(uint256 indexed listingId, address indexed seller, address indexed buyer, uint256 amount, uint256 totalPrice, uint256 fee, uint256 timestamp)"
        ];

        // Global variables
        let provider;
        let signer;
        let contract;
        let userAddress;
        let progressUpdateInterval;

        // DOM elements
        const connectWalletBtn = document.getElementById('connectWallet');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddress = document.getElementById('walletAddress');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const mintAmountInput = document.getElementById('mintAmount');
        const receiveAmountInput = document.getElementById('receiveAmount');
        const totalFeeInput = document.getElementById('totalFee');
        const userMintCountInput = document.getElementById('userMintCount');
        const listingAmountInput = document.getElementById('listingAmount');
        const listingPriceInput = document.getElementById('listingPrice');
        const totalListingPriceInput = document.getElementById('totalListingPrice');

        // Add Monad Network to MetaMask
        window.addMonadNetwork = async function() {
            if (typeof window.ethereum === 'undefined') {
                showNotification('Please install MetaMask first!', 'error');
                return;
            }

            try {
                await ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: ethers.utils.hexValue(CONFIG.CHAIN_ID),
                        chainName: CONFIG.CHAIN_NAME,
                        rpcUrls: [CONFIG.RPC_URL],
                        blockExplorerUrls: [CONFIG.BLOCK_EXPLORER],
                        nativeCurrency: {
                            name: 'MON',
                            symbol: 'MON',
                            decimals: 18
                        }
                    }],
                });
                showNotification('Monad Network added successfully!', 'success');
            } catch (error) {
                console.error('Add network error:', error);
                if (error.code === 4902) {
                    showNotification('Network already exists in your wallet', 'error');
                } else {
                    showNotification('Failed to add network: ' + error.message, 'error');
                }
            }
        }

        // Initialize
        async function init() {
            if (typeof window.ethereum !== 'undefined') {
                connectWalletBtn.addEventListener('click', connectWallet);
                updateMintCalculations();
                updateListingCalculations();
                
                // Start progress updates
                startProgressUpdates();
            } else {
                showNotification('Please install MetaMask to use this dApp!', 'error');
            }
        }

        // Connect Wallet
        async function connectWallet() {
            try {
                // Request accounts
                await ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Check if on correct network
                const network = await provider.getNetwork();
                console.log('Current network:', network.chainId);
                console.log('Required network:', CONFIG.CHAIN_ID);
                
                if (network.chainId !== CONFIG.CHAIN_ID) {
                    showNotification(`Wrong network! Switching to Monad Mainnet (Chain ID: ${CONFIG.CHAIN_ID})...`, 'error');
                    await switchNetwork();
                    // Refresh provider after network switch
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                }

                // Initialize contract
                contract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Update UI
                walletAddress.textContent = formatAddress(userAddress);
                connectWalletBtn.style.display = 'none';
                walletInfo.style.display = 'block';

                // Load data
                await loadAllData();

                showNotification('Wallet connected successfully!', 'success');

                // Listen for events
                setupEventListeners();

                // Listen for account changes
                ethereum.on('accountsChanged', function (accounts) {
                    if (accounts.length === 0) {
                        // User disconnected wallet
                        location.reload();
                    } else {
                        // User switched account
                        location.reload();
                    }
                });

                // Listen for chain changes
                ethereum.on('chainChanged', function (chainId) {
                    location.reload();
                });

            } catch (error) {
                console.error('Connection error:', error);
                
                if (error.code === 4001) {
                    showNotification('Connection rejected by user', 'error');
                } else if (error.code === -32002) {
                    showNotification('Please check MetaMask - connection request pending', 'error');
                } else {
                    showNotification('Failed to connect: ' + (error.message || 'Unknown error'), 'error');
                }
            }
        }

        // Switch to Monad Network
        async function switchNetwork() {
            try {
                await ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: ethers.utils.hexValue(CONFIG.CHAIN_ID) }],
                });
            } catch (switchError) {
                // Network doesn't exist, add it
                if (switchError.code === 4902 || switchError.code === -32603) {
                    try {
                        await ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: ethers.utils.hexValue(CONFIG.CHAIN_ID),
                                chainName: CONFIG.CHAIN_NAME,
                                rpcUrls: [CONFIG.RPC_URL],
                                blockExplorerUrls: [CONFIG.BLOCK_EXPLORER],
                                nativeCurrency: {
                                    name: 'MON',
                                    symbol: 'MON',
                                    decimals: 18
                                }
                            }],
                        });
                        showNotification('Monad Network added successfully! Please switch to it.', 'success');
                    } catch (addError) {
                        console.error('Add network error:', addError);
                        showNotification('Failed to add Monad Network. Please add it manually in MetaMask.', 'error');
                        throw addError;
                    }
                } else {
                    throw switchError;
                }
            }
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadProgress(),
                loadUserStats(),
                loadMarketplaceListings()
            ]);
        }

        // Load progress data
        async function loadProgress() {
            try {
                const progress = await contract.getMintProgress();
                
                const minted = progress.minted.toNumber();
                const maxSupply = progress.maxSupply.toNumber();
                const percent = progress.percentComplete.toNumber();
                const inscriptions = progress.inscriptionsCount.toNumber();

                document.getElementById('totalMinted').textContent = minted.toLocaleString();
                document.getElementById('totalInscriptions').textContent = inscriptions.toLocaleString();
                document.getElementById('progressPercent').textContent = percent + '%';
                document.getElementById('progressBar').style.width = percent + '%';

                // Calculate holders (estimate from mint events)
                await calculateHolders();

            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }

        // Calculate unique holders from events
        async function calculateHolders() {
            try {
                // Get mint events to count unique addresses
                const mintFilter = contract.filters.TokensMinted();
                const mintEvents = await contract.queryFilter(mintFilter, 0, 'latest');
                
                const uniqueHolders = new Set();
                mintEvents.forEach(event => {
                    uniqueHolders.add(event.args.minter.toLowerCase());
                });

                document.getElementById('totalHolders').textContent = uniqueHolders.size.toLocaleString();
            } catch (error) {
                console.error('Error calculating holders:', error);
                // Fallback to estimate
                const totalMinted = parseInt(document.getElementById('totalMinted').textContent.replace(/,/g, ''));
                const estimatedHolders = Math.floor(totalMinted / 100); // Rough estimate
                document.getElementById('totalHolders').textContent = estimatedHolders.toLocaleString();
            }
        }

        // Load user stats
        async function loadUserStats() {
            if (!userAddress || !contract) return;

            try {
                const stats = await contract.getUserStats(userAddress);
                
                const balance = stats.balance.toNumber();
                const mints = stats.mints.toNumber();
                const maxMints = stats.maxMints.toNumber();

                document.getElementById('userBalance').textContent = balance.toLocaleString();
                userMintCountInput.value = `${mints} / ${maxMints}`;

            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Start periodic progress updates
        function startProgressUpdates() {
            // Update every 5 seconds
            progressUpdateInterval = setInterval(async () => {
                if (contract) {
                    await loadProgress();
                }
            }, 5000);
        }

        // Setup event listeners for real-time updates
        function setupEventListeners() {
            if (!contract) return;

            // Listen for mint events
            contract.on("TokensMinted", async (minter, amount, totalMinted, timestamp) => {
                console.log('New mint detected!', {minter, amount: amount.toString(), totalMinted: totalMinted.toString()});
                await loadProgress();
                
                if (minter.toLowerCase() === userAddress.toLowerCase()) {
                    await loadUserStats();
                    showNotification(`Successfully minted ${amount.toNumber()} MONS!`, 'success');
                }
            });

            // Listen for listing events
            contract.on("ListingCreated", async (listingId, seller, amount, pricePerToken, timestamp) => {
                console.log('New listing created!', {listingId: listingId.toString(), seller});
                await loadMarketplaceListings();
                
                if (seller.toLowerCase() === userAddress.toLowerCase()) {
                    await loadUserListings();
                    showNotification('Listing created successfully!', 'success');
                }
            });

            // Listen for sale events
            contract.on("ListingFilled", async (listingId, seller, buyer, amount, totalPrice, fee, timestamp) => {
                console.log('Listing filled!', {listingId: listingId.toString(), buyer});
                await loadMarketplaceListings();
                
                if (buyer.toLowerCase() === userAddress.toLowerCase() || seller.toLowerCase() === userAddress.toLowerCase()) {
                    await loadUserStats();
                    await loadUserListings();
                }
            });
        }

        // Tab Navigation
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(targetTab + 'Tab').classList.add('active');

                // Load data when switching to marketplace or my listings
                if (targetTab === 'marketplace') {
                    loadMarketplaceListings();
                } else if (targetTab === 'myListings') {
                    loadUserListings();
                }
            });
        });

        // Mint calculations
        mintAmountInput.addEventListener('input', updateMintCalculations);

        function updateMintCalculations() {
            const numMints = parseInt(mintAmountInput.value) || 1;
            const clampedMints = Math.max(1, Math.min(100, numMints));
            
            if (numMints !== clampedMints) {
                mintAmountInput.value = clampedMints;
            }

            const totalTokens = clampedMints * 100;
            const totalFee = clampedMints * parseFloat(CONFIG.INSCRIPTION_FEE);

            receiveAmountInput.value = `${totalTokens.toLocaleString()} MONS`;
            totalFeeInput.value = `${totalFee.toLocaleString()} MON`;
        }

        // Listing calculations
        listingAmountInput.addEventListener('input', updateListingCalculations);
        listingPriceInput.addEventListener('input', updateListingCalculations);

        function updateListingCalculations() {
            const amount = parseInt(listingAmountInput.value) || 0;
            const price = parseFloat(listingPriceInput.value) || 0;
            const total = amount * price;
            totalListingPriceInput.value = `${total.toFixed(6)} MON`;
        }

        // Mint Form
        document.getElementById('mintForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userAddress) {
                showNotification('Please connect your wallet first!', 'error');
                return;
            }

            const numMints = parseInt(mintAmountInput.value);
            
            try {
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Minting...';

                // Create mint inscription
                const mintData = `data:,{"p":"mon-20","op":"mint","tick":"mons","amt":"100"}`;
                const dataBytes = ethers.utils.toUtf8Bytes(mintData);
                
                const totalFee = ethers.utils.parseEther((numMints * parseFloat(CONFIG.INSCRIPTION_FEE)).toString());
                
                let tx;
                if (numMints === 1) {
                    tx = await contract.inscribe(dataBytes, { value: totalFee });
                } else {
                    const dataArray = Array(numMints).fill(dataBytes);
                    tx = await contract.batchInscribe(dataArray, { value: totalFee });
                }
                
                showNotification('Transaction submitted! Waiting for confirmation...', 'success');
                
                await tx.wait();
                
                showNotification(`Successfully minted ${numMints * 100} MONS!`, 'success');
                
                await loadAllData();

            } catch (error) {
                console.error('Mint error:', error);
                showNotification('Mint failed: ' + error.message, 'error');
            } finally {
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = false;
                button.textContent = 'Mint MONS';
            }
        });

        // Transfer Form
        document.getElementById('transferForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userAddress) {
                showNotification('Please connect your wallet first!', 'error');
                return;
            }

            if (!contract) {
                showNotification('Contract not initialized.', 'error');
                return;
            }

            const recipient = document.getElementById('recipientAddress').value.trim();
            const amount = parseInt(document.getElementById('transferAmount').value);

            if (!recipient) {
                showNotification('Please enter recipient address!', 'error');
                return;
            }

            if (!ethers.utils.isAddress(recipient)) {
                showNotification('Invalid recipient address!', 'error');
                return;
            }

            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount!', 'error');
                return;
            }

            try {
                // Get current balance first
                const userStats = await contract.getUserStats(userAddress);
                const currentBalance = userStats.balance.toNumber();

                if (amount > currentBalance) {
                    showNotification(`Insufficient balance! You have ${currentBalance} MONS`, 'error');
                    return;
                }

                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Transferring...';

                const tx = await contract.transfer(recipient, amount, { 
                    value: ethers.utils.parseEther(CONFIG.INSCRIPTION_FEE),
                    gasLimit: 300000
                });
                
                showNotification('Transaction submitted! Waiting for confirmation...', 'success');
                
                await tx.wait();
                
                showNotification(`Successfully transferred ${amount} MONS!`, 'success');
                
                await loadAllData();
                document.getElementById('transferForm').reset();

            } catch (error) {
                console.error('Transfer error:', error);
                
                let errorMessage = 'Transfer failed';
                if (error.code === 4001) {
                    errorMessage = 'Transaction rejected by user';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = 'Insufficient MON for gas + fee';
                } else if (error.message.includes('execution reverted')) {
                    errorMessage = 'Transaction reverted. Check your balance.';
                } else if (error.data?.message) {
                    errorMessage = error.data.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = false;
                button.textContent = 'Transfer Tokens';
            }
        });

        // Create Listing Form
        document.getElementById('createListingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userAddress) {
                showNotification('Please connect your wallet first!', 'error');
                return;
            }

            const amount = parseInt(listingAmountInput.value);
            const pricePerToken = parseFloat(listingPriceInput.value);

            try {
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Creating...';

                // Convert price to wei (assuming pricePerToken is in MON)
                const priceInWei = ethers.utils.parseEther(pricePerToken.toString());

                const tx = await contract.createListing(amount, priceInWei);
                
                showNotification('Transaction submitted! Waiting for confirmation...', 'success');
                
                await tx.wait();
                
                showNotification('Listing created successfully!', 'success');
                
                await loadAllData();
                await loadUserListings();
                document.getElementById('createListingForm').reset();
                updateListingCalculations();

            } catch (error) {
                console.error('Create listing error:', error);
                showNotification('Create listing failed: ' + error.message, 'error');
            } finally {
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = false;
                button.textContent = 'Create Listing';
            }
        });

        // Load Marketplace Listings
        async function loadMarketplaceListings() {
            if (!contract) return;

            try {
                const listings = await contract.getActiveListings(0, 50);
                const container = document.getElementById('marketplaceListings');
                container.innerHTML = '';

                if (listings.listingIds.length === 0) {
                    container.innerHTML = '<p style="color: rgba(250, 248, 243, 0.6); text-align: center; padding: 2rem;">No active listings</p>';
                    return;
                }

                for (let i = 0; i < listings.listingIds.length; i++) {
                    const listingId = listings.listingIds[i].toNumber();
                    const seller = listings.sellers[i];
                    const amount = listings.amounts[i].toNumber();
                    const price = ethers.utils.formatEther(listings.prices[i]);
                    const totalPrice = parseFloat(price) * amount;

                    const card = document.createElement('div');
                    card.className = 'listing-card';
                    card.innerHTML = `
                        <div class="listing-seller">Seller: ${formatAddress(seller)}</div>
                        <div class="listing-amount">${amount.toLocaleString()} MONS</div>
                        <div class="listing-price">${parseFloat(price).toFixed(6)} MON/token</div>
                        <div class="listing-price" style="font-size: 1rem; color: var(--gold-light);">
                            Total: ${totalPrice.toFixed(6)} MON
                        </div>
                        ${userAddress && seller.toLowerCase() !== userAddress.toLowerCase() ? 
                            `<div class="listing-actions">
                                <button onclick="buyListing(${listingId}, ${totalPrice})" class="btn btn-success" style="width: 100%;">
                                    Buy Now
                                </button>
                            </div>` : 
                            userAddress && seller.toLowerCase() === userAddress.toLowerCase() ?
                            '<div style="color: rgba(250, 248, 243, 0.6); font-size: 0.8rem; margin-top: 1rem;">Your listing</div>' :
                            ''
                        }
                    `;
                    container.appendChild(card);
                }

            } catch (error) {
                console.error('Error loading marketplace listings:', error);
            }
        }

        // Buy Listing
        window.buyListing = async function(listingId, totalPrice) {
            try {
                const tx = await contract.buyListing(listingId, {
                    value: ethers.utils.parseEther(totalPrice.toString())
                });

                showNotification('Purchase submitted! Waiting for confirmation...', 'success');
                
                await tx.wait();
                
                showNotification('Purchase successful!', 'success');
                
                await loadAllData();
                await loadMarketplaceListings();

            } catch (error) {
                console.error('Buy error:', error);
                showNotification('Purchase failed: ' + error.message, 'error');
            }
        }

        // Load User Listings
        async function loadUserListings() {
            if (!userAddress || !contract) return;

            try {
                const listingIds = await contract.getUserListings(userAddress);
                const container = document.getElementById('userListings');
                container.innerHTML = '';

                if (listingIds.length === 0) {
                    container.innerHTML = '<p style="color: rgba(250, 248, 243, 0.6); text-align: center; padding: 2rem;">No active listings</p>';
                    return;
                }

                for (let i = 0; i < listingIds.length; i++) {
                    const listingId = listingIds[i].toNumber();
                    const listing = await contract.getListing(listingId);
                    
                    if (!listing.active) continue;

                    const amount = listing.amount.toNumber();
                    const price = ethers.utils.formatEther(listing.pricePerToken);
                    const totalPrice = parseFloat(price) * amount;

                    const card = document.createElement('div');
                    card.className = 'listing-card';
                    card.innerHTML = `
                        <div class="listing-amount">${amount.toLocaleString()} MONS</div>
                        <div class="listing-price">${parseFloat(price).toFixed(6)} MON/token</div>
                        <div class="listing-price" style="font-size: 1rem; color: var(--gold-light);">
                            Total: ${totalPrice.toFixed(6)} MON
                        </div>
                        <div class="listing-actions">
                            <button onclick="cancelListing(${listingId})" class="btn btn-secondary" style="width: 100%;">
                                Cancel Listing
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                }

            } catch (error) {
                console.error('Error loading user listings:', error);
            }
        }

        // Cancel Listing
        window.cancelListing = async function(listingId) {
            try {
                const tx = await contract.cancelListing(listingId);
                
                showNotification('Cancellation submitted! Waiting for confirmation...', 'success');
                
                await tx.wait();
                
                showNotification('Listing cancelled successfully!', 'success');
                
                await loadAllData();
                await loadUserListings();

            } catch (error) {
                console.error('Cancel error:', error);
                showNotification('Cancellation failed: ' + error.message, 'error');
            }
        }

        // Refresh listings button
        document.getElementById('refreshListings').addEventListener('click', loadMarketplaceListings);

        // Utility Functions
        function formatAddress(address) {
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-title">${type === 'success' ? '‚úì Success' : '‚úó Error'}</div>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.5s ease reverse';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        // Initialize on page load
        init();

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (progressUpdateInterval) {
                clearInterval(progressUpdateInterval);
            }
        });
    </script>
</body>
</html>
